if(getCookie("id") === "" || getCookie("id") === "0") {
    location.href = "index.html";
} else {
    function addPatient() {
        if ($("#add-paciente").hasClass("hide")) {
            openPaciente()
        } else {
            closePaciente()
        }
    }

    function openPaciente() {
        $("#add-paciente").removeClass("hide");
        animateFadeEffect("#add-paciente")
    }

    function closePaciente() {
        let time = animateFadeReverse("#add-paciente");
        setTimeout(function () {
            $("#add-paciente").addClass("hide")
        }, time + 500);
        $("#nome").val("");
        $("#telefone").val("")
    }

    function closeConvite() {
        $("#convite-paciente").addClass("hide")
    }

    function closePendentes() {
        let time = animateFadeReverse("#pedidos-pendentes");
        setTimeout(function () {
            $("#pedidos-pendentes").addClass("hide")
        }, time + 500)
    }

    var envioStatus = !1;

    function enviarconvite() {
        if (!envioStatus) {
            envioStatus = !0;
            let medico = {
                "name": $("#nome").val(),
                "phone_number": iti.getSelectedCountryData().dialCode + $("#telefone").cleanVal()
            };
            if (validateMedico(medico)) {
                let pp = "...";
                $("#sendconvite").html("enviando&nbsp;&nbsp;&nbsp;");
                let t = setInterval(function () {
                    pp = (pp === "..." ? ".&nbsp;&nbsp;" : (pp === "..&nbsp;" ? "..." : "..&nbsp;"));
                    $("#sendconvite").html("enviando" + pp)
                }, 500);
                toast("Enviando", 2000);

                apiPost("pending", {
                    "doctor_id": parseInt(getCookie("id")),
                    "phone_number": medico.phone_number
                }).then(g => {
                    toast(g, 7000, "toast-warning");
                    if (g !== "Voce ja enviou convite para esse paciente. Aguarde o(a) paciente aceitar o convite para receber os dados dele(a)") {
                        $("#nome").val("");
                        $("#telefone").val("");
                        toast("Paciente adicionado!", 3000, "toast-success");
                        $("#convite-paciente").removeClass("hide");
                        $("#convite-nome").html(medico.name);
                        $("#add-paciente").addClass("hide");
                        animateFadeEffect("#convite-paciente")
                    }
                }).catch(g => {
                    if(g === "Erro") {
                        $("#nome").val("");
                        $("#telefone").val("");
                        toast("Paciente adicionado!", 3000, "toast-success");
                        $("#convite-paciente").removeClass("hide");
                        $("#convite-nome").html(medico.name);
                        $("#add-paciente").addClass("hide");
                        animateFadeEffect("#convite-paciente");
                    } else {
                        toast("Paciente não encontrado", 3500, "toast-warning");
                    }
                }).finally(e => {
                    clearInterval(t);
                    $("#sendconvite").html("Enviar Convite");
                    envioStatus = !1;
                })
            } else {
                envioStatus = !1;
                toast("Corrija o formulário", 2500, "toast-error")
            }
        }
    }

    $("body").off("click", ".arrowback").on("click", ".arrowback", function () {
        closePaciente();
        closeConvite();
        closePendentes()
    });

    function search(val) {
        return dbLocal.exeRead("pacientes").then(pacientes => {
            return pacientes.filter((e) => {
                return e.first_name.search(val.trim()) > -1 || e.first_name.toLowerCase().search(val.trim()) > -1
            })
        }).then(pacientes => {
            getJSON('public/language/' + LANG + '/cardPaciente.json').then(lang => {
                $("#lista-pacientes").html("");
                if (!isEmpty(pacientes)) {
                    getRequest('public/tpl/paciente.mustache').then(tpl => {
                        $.each(pacientes, function (i, e) {
                            $("#lista-pacientes").append(Mustache.render(tpl, Object.assign({}, lang, e)))
                        });
                    });
                } else {
                    getRequest('public/tpl/pacienteEmpty.mustache').then(tpl => {
                        $("#lista-pacientes").append(Mustache.render(tpl.pacienteEmpty, lang))
                    });
                }
            })
        })
    }

    function showError(mensagem, id) {
        $(".input-message[rel='" + id + "']").html(mensagem);
        $("#" + id).css("border-color", "red");
        error = !0;
        navigator.vibrate(100)
    }

    function clearError(id) {
        $(".input-message[rel='" + id + "']").html("");
        $("#" + id).css("border-color", "#999")
    }

    var error = !1;

    function validateMedico(medico) {
        error = !1;
        if (typeof medico.phone_number !== "string" || medico.phone_number === "")
            showError("Preencha este campo", "telefone");
        return !error
    }

    /*function pedidosPendentes() {
        $("#pedidos-pendentes").removeClass("hide");
        animateFadeEffect("#pedidos-pendentes");
        showPendentes();
    }

    function showPendentes() {
        let pacientes = [];
        pacientes.push({id:1, nome: "Edinei", imagem: "public/assets/img/foto-padrao.png", descricao: "Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book."});
        pacientes.push({id:1, nome: "Edinei", imagem: "public/assets/img/foto-padrao.png", descricao: "Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book."});
        pacientes.push({id:1, nome: "Edinei", imagem: "public/assets/img/foto-padrao.png", descricao: "Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s."});
        $("#pacientes-pendentes-list").htmlTemplate("pacientePendenteCard", {pacientes: pacientes});
    }*/

    function aceitarConvite(id) {
        apiPost('accept', {id: id}).then(r => {
            console.log(r);
        });
    }

    function negarConvite(id) {
        apiPost('deny', {id: id}).then(r => {
            console.log(r);
        });
    }

    var iti = null;
    var searchTime = null;
    $(function () {
        let SPMaskBehavior = function (val) {
            return val.replace(/\D/g, '').length === 11 ? '(00) 00000-0000' : '(00) 0000-00009'
        }, spOptions = {
            onKeyPress: function (val, e, field, options) {
                field.mask(SPMaskBehavior.apply({}, arguments), options)
            }
        };
        $("input[type='tel']").mask(SPMaskBehavior, spOptions);
        $("input").off("change keyup").on("change keyup", function () {
            clearError($(this).attr("id"))
        });
        $("#search-paciente").off("keyup").on("keyup", function () {
            let v = $(this).val();
            clearTimeout(searchTime);
            searchTime = setTimeout(function () {
                search(v)
            }, 500)
        });
        $("#btn-search").off("click").on("click", function () {
            clearTimeout(searchTime);
            search($("#search-paciente").val())
        });
        readPacientes().then(pacientes => {
            getJSON('public/language/' + LANG + '/cardPaciente.json').then(lang => {
                $("#lista-pacientes").html("");
                if (!isEmpty(pacientes)) {
                    getRequest('public/tpl/paciente.mustache').then(tpl => {
                        $.each(pacientes, function (i, e) {
                            if (i > 7)
                                return !1;
                            $("#lista-pacientes").append(Mustache.render(tpl, Object.assign({}, lang, e)))
                        })
                    })
                } else {
                    getRequest('public/tpl/pacienteEmpty.mustache').then(tpl => {
                        $("#lista-pacientes").append(Mustache.render(tpl, lang))
                    })
                }
            })
        });
        getJSON('public/language/' + LANG + '/ajustes.json').then(lang => {
            getRequest('public/tpl/ajustes.mustache').then(tpl => {
                $("#pacientes").append(Mustache.render(tpl, lang))
            })
        });

        let aint = setInterval(function () {
            if($("#telefone").length) {
                let input = document.querySelector("#telefone");
                iti = intlTelInput(input, {
                    dropdownContainer: document.body,
                    initialCountry: "br",
                    utilsScript: "assets/utils.js"
                });
                clearInterval(aint);
            }
        }, 50);
    })
}