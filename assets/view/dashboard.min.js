if (getCookie("id") === "" || getCookie("id") === "0") {
    location.href = "index.html";
} else {
    function addPatient() {
        if ($("#add-paciente").hasClass("hide")) {
            openPaciente()
        } else {
            closePaciente()
        }
    }

    function openPaciente() {
        $("#add-paciente").removeClass("hide");
        animateFadeEffect("#add-paciente")
    }

    function closePaciente() {
        let time = animateFadeReverse("#add-paciente");
        setTimeout(function () {
            $("#add-paciente").addClass("hide")
        }, time + 500);
        $("#nome").val("");
        $("#telefone").val("")
    }

    function closeConvite() {
        $("#convite-paciente").addClass("hide")
    }

    var envioStatus = !1;

    function enviarconvite() {
        if (!envioStatus) {
            envioStatus = !0;
            let medico = {
                "name": $("#nome").val(),
                "phone_number": iti.getSelectedCountryData().dialCode + $("#telefone").cleanVal()
            };
            if (validateMedico(medico)) {
                let pp = "...";
                $("#sendconvite").html("enviando&nbsp;&nbsp;&nbsp;");
                let t = setInterval(function () {
                    pp = (pp === "..." ? ".&nbsp;&nbsp;" : (pp === "..&nbsp;" ? "..." : "..&nbsp;"));
                    $("#sendconvite").html("enviando" + pp)
                }, 500);
                toast("Enviando", 2000);

                apiPost("pending", {
                    "doctor_id": parseInt(getCookie("id")),
                    "phone_number": medico.phone_number
                }).then(g => {
                    toast(g, 7000, "toast-warning");
                    if (g !== "Voce ja enviou convite para esse paciente. Aguarde o(a) paciente aceitar o convite para receber os dados dele(a)") {
                        $("#nome").val("");
                        $("#telefone").val("");
                        toast("Paciente adicionado!", 3000, "toast-success");
                        $("#convite-paciente").removeClass("hide");
                        $("#convite-nome").html(medico.name);
                        $("#add-paciente").addClass("hide");
                        animateFadeEffect("#convite-paciente")
                    }
                }).catch(g => {
                    if(g === "Erro") {
                        $("#nome").val("");
                        $("#telefone").val("");
                        toast("Paciente adicionado!", 3000, "toast-success");
                        $("#convite-paciente").removeClass("hide");
                        $("#convite-nome").html(medico.name);
                        $("#add-paciente").addClass("hide");
                        animateFadeEffect("#convite-paciente");
                    } else {
                        toast("Paciente não encontrado", 3500, "toast-warning");
                    }
                }).finally(() => {
                    clearInterval(t);
                    $("#sendconvite").html("Enviar Convite");
                    envioStatus = !1;
                })
            } else {
                envioStatus = !1;
                toast("Corrija o formulário", 2500, "toast-error")
            }
        }
    }

    $("body").off("click", ".arrowback").on("click", ".arrowback", function () {
        closePaciente();
        closeConvite()
    });

    function showError(mensagem, id) {
        $(".input-message[rel='" + id + "']").html(mensagem);
        $("#" + id).css("border-color", "red");
        error = !0;
        navigator.vibrate(100)
    }

    function clearError(id) {
        $(".input-message[rel='" + id + "']").html("");
        $("#" + id).css("border-color", "#999")
    }

    var error = !1;

    function validateMedico(medico) {
        error = !1;
        if (typeof medico.phone_number !== "string" || medico.phone_number === "")
            showError("Preencha este campo", "telefone");
        return !error
    }

    function readUpdatesPacientesServer() {
        return apiPost("lastModification", {"doctor_id": parseInt(getCookie("id"))}).then(p => {
            return dbLocal.clear("pacientesUpdates").then(() => {
                let a = [];
                $.each(p, function (i, e) {
                    a.push(dbLocal.exeRead("pacientes", e.patientID).then(data => {

                        //vincula o paciente à atualizações
                        e.patient = data;
                        e.id = i + 1;
                        return dbLocal.exeCreate("pacientesUpdates", e)
                    }));
                });
                return Promise.all(a).then(d => {
                    return p;
                })
            });
        });
    }

    function readUpdatesPacientes() {
        return dbLocal.exeRead("pacientesUpdates").then(data => {
            if (!isEmpty(data)) {
                readUpdatesPacientesServer();
                return data;
            } else {
                return readUpdatesPacientesServer()
            }
        })
    }

    var iti = null;
    $(function () {
        updatePerfilPage();
        let SPMaskBehavior = function (val) {
            return val.replace(/\D/g, '').length === 11 ? '(00) 00000-0000' : '(00) 0000-00009'
        }, spOptions = {
            onKeyPress: function (val, e, field, options) {
                field.mask(SPMaskBehavior.apply({}, arguments), options)
            }
        };
        $("input[type='tel']").mask(SPMaskBehavior, spOptions);
        $("input").off("change keyup").on("change keyup", function () {
            clearError($(this).attr("id"))
        });

        readPacientes().then(pacientes => {
            getJSON('public/language/' + LANG + '/cardPaciente.json').then(lang => {
                $("#lista-pacientes").html("");
                if (!isEmpty(pacientes)) {
                    getRequest('public/tpl/paciente.mustache').then(tpl => {
                        $.each(pacientes, function (i, e) {
                            if (i > 7)
                                return !1;
                            $("#lista-pacientes").append(Mustache.render(tpl, Object.assign({}, lang, e)))
                        })
                    })
                } else {
                    getRequest('public/tpl/pacienteEmpty.mustache').then(tpl => {
                        $("#lista-pacientes").append(Mustache.render(tpl, lang))
                    })
                }
            })
        }).then(() => {

            /**
             * Faz a leitura das atualizações
             */
            readUpdatesPacientes().then(atualizacoes => {

                /**
                 * Obtém as traduções da lingua atual selecionada
                 */
                return getJSON('public/language/' + LANG + '/dashboard.json').then(lang => {

                    /**
                     * Limpa a timeline no HTML
                     */
                    $("#timeline").html("");
                    if (!isEmpty(atualizacoes)) {

                        /**
                         * Inverte as atualizações para ter a lista dos mais recentes primeiro
                         */
                        atualizacoes.reverse();

                        /**
                         * Obtém o template
                         */
                        getRequest('public/tpl/pacientesUpdates.mustache').then(tpl => {

                            /**
                             * Para cada atualizaçõa de paciente
                             */
                            $.each(atualizacoes, function (i, e) {

                                //formata a data para mostrar de forma mais amigável
                                e.date = moment(e.date).format("lll");

                                //aplica os valores da atualização do paciente e o idioma no template
                                $("#timeline").append(Mustache.render(tpl, Object.assign({}, lang, e)))
                            });
                        });
                    } else {

                        /**
                         * Caso não tenha atualizações, mostra um template com nenhuma atualização
                         */
                        let d = new Date();
                        getRequest('public/tpl/pacientesUpdatesEmpty.mustache').then(tpl => {
                            $("#timeline").append(Mustache.render(tpl, Object.assign({img: "nothing"}, lang)));
                        })
                    }
                })
            })
        });
        clearToast();
        getJSON('public/language/' + LANG + '/ajustes.json').then(lang => {
            getRequest('public/tpl/ajustes.mustache').then(tpl => {
                $("#dashboard").append(Mustache.render(tpl, lang))
            })
        })

        let aint = setInterval(function () {
            if ($("#telefone").length) {
                updatePerfilPage();
                let input = document.querySelector("#telefone");
                iti = intlTelInput(input, {
                    dropdownContainer: document.body,
                    initialCountry: "br",
                    utilsScript: "assets/utils.js"
                });
                clearInterval(aint);
            }
        }, 50);
    })
}